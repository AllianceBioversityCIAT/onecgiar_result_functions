{
  "openapi": "3.0.3",
  "info": {
    "title": "PRMS Normalizer API",
    "version": "1.1.0",
    "description": "Validates, normalizes and publishes results to EventBridge."
  },
  "servers": [{ "url": "/" }],
  "paths": {
    "/ingest": {
      "post": {
        "summary": "Ingest 1..n results",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": { "$ref": "#/components/schemas/IngestRequest" },
              "examples": {
                "kpRegional": {
                  "summary": "Knowledge Product — Regional (scope_code=2, requires regions[])",
                  "value": {
                    "tenant": "prms.result-management.api",
                    "op": "dataset.ingest.requested",
                    "results": [
                      {
                        "type": "knowledge_product",
                        "data": {
                          "created_date": "2025-10-08T14:30:00Z",
                          "created_by": {
                            "email": "researcher@cgiar.org",
                            "name": "Research Team Lead"
                          },
                          "submitted_by": {
                            "email": "j.doe@cgiar.org",
                            "name": "Juan David Delgado",
                            "comment": "Initial load from STAR",
                            "submitted_date": "2025-10-09T12:00:00Z"
                          },
                          "lead_center": "Alliance of Bioversity International and CIAT",
                          "title": "Improved seed varieties adoption in drylands",
                          "description": "This knowledge product summarizes adoption barriers and enabling factors across regions to inform policy and practice for smallholders in drylands.",
                          "toc_mapping": [
                            {
                              "science_program_id": "SP12",
                              "aow_compose_code": "SP12-AOW01",
                              "result_title": "Adoption of improved seed varieties",
                              "result_indicator_description": "Share of farmers adopting improved seeds",
                              "result_indicator_type_name": "# Of Knowledge Products"
                            }
                          ],
                          "geo_focus": {
                            "scope_code": 2,
                            "scope_label": "Regional",
                            "regions": [
                              { "um49code": 145, "name": "Sub-Saharan Africa" }
                            ]
                          },
                          "contributing_center": [
                            {
                              "institution_id": 1279,
                              "acronym": "ICARDA"
                            },
                            { "institution_id": 115, "acronym": "CIFOR" }
                          ],
                          "contributing_partners": [
                            { "institution_id": 1, "acronym": "WUR" },
                            { "institution_id": 7, "acronym": "NARO" }
                          ],
                          "evidence": [
                            {
                              "link": "https://example.org/paper-123",
                              "description": "Peer-reviewed article summarizing multi-country trials and yield effects."
                            }
                          ],
                          "contributing_bilateral_projects": [
                            { "grant_title": "Seed Innovation Window" },
                            { "grant_title": "Climate-Resilient Varieties" }
                          ],
                          "knowledge_product": {
                            "handle": "hdl:20.500.12345/abc-2025",
                            "knowledge_product_type": "Journal Article",
                            "metadataCG": {
                              "source": "CGSpace",
                              "accessibility": true,
                              "doi": "10.1000/j.jas.2025.01.001",
                              "is_isi": true,
                              "is_peer_reviewed": true,
                              "issue_year": 2025
                            },
                            "licence": "CC-BY 4.0",
                            "agrovoc_keywords": [
                              "Wheat",
                              "Variety trials",
                              "Climate adaptation"
                            ]
                          }
                        }
                      }
                    ]
                  }
                },
                "kpNational": {
                  "summary": "Knowledge Product — National (scope_code=4, requires countries[≥1])",
                  "value": {
                    "tenant": "prms.result-management.api",
                    "results": [
                      {
                        "type": "knowledge_product",
                        "data": {
                          "created_date": "2025-10-09T16:45:00Z",
                          "created_by": {
                            "email": "policy.team@cgiar.org",
                            "name": "Policy Research Team"
                          },
                          "submitted_by": {
                            "email": "m.lee@cgiar.org",
                            "name": "María Lee",
                            "submitted_date": "2025-10-10T10:30:00Z"
                          },
                          "lead_center": "CIAT",
                          "title": "National varietal release guidelines",
                          "description": "Guidelines to streamline varietal release at national level.",
                          "toc_mapping": [
                            {
                              "science_program_id": "SP05",
                              "aow_compose_code": "SP05-AOW02",
                              "result_title": "National policy brief",
                              "result_indicator_description": "Policy briefs produced",
                              "result_indicator_type_name": "# Of Knowledge Products"
                            }
                          ],
                          "geo_focus": {
                            "scope_code": 4,
                            "scope_label": "National",
                            "countries": [
                              {
                                "id": 170,
                                "name": "Colombia",
                                "iso_alpha_3": "COL",
                                "iso_alpha_2": "CO"
                              }
                            ]
                          },
                          "contributing_center": [
                            { "institution_id": 115, "acronym": "CIFOR" }
                          ],
                          "contributing_partners": [
                            { "institution_id": 22, "acronym": "MADR" }
                          ],
                          "evidence": [
                            {
                              "link": "https://example.org/policy-brief",
                              "description": "Official policy brief"
                            }
                          ],
                          "contributing_bilateral_projects": [
                            { "grant_title": "AgPolicy 2025" }
                          ],
                          "knowledge_product": {
                            "handle": "hdl:20.500.12345/pb-2025-01",
                            "knowledge_product_type": "Policy Brief",
                            "metadataCG": {
                              "source": "CGSpace",
                              "accessibility": true,
                              "doi": "10.1000/pb.2025.01",
                              "is_isi": false,
                              "is_peer_reviewed": false,
                              "issue_year": 2025
                            },
                            "licence": "CC-BY 4.0",
                            "agrovoc_keywords": ["Policy", "Agriculture"]
                          }
                        }
                      }
                    ]
                  }
                },
                "kpSubnational": {
                  "summary": "Knowledge Product — Sub-national (scope_code=5, requires countries[≥1] and subnational_areas[≥1])",
                  "value": {
                    "tenant": "prms.result-management.api",
                    "results": [
                      {
                        "type": "knowledge_product",
                        "data": {
                          "created_date": "2025-10-09T09:20:00Z",
                          "created_by": {
                            "email": "data.team@cgiar.org",
                            "name": "Data Science Team"
                          },
                          "submitted_by": {
                            "email": "l.garcia@cgiar.org",
                            "name": "Luis García",
                            "submitted_date": "2025-10-10T11:15:00Z"
                          },
                          "lead_center": "CIAT",
                          "title": "County-level varietal adoption",
                          "description": "Dataset on varietal adoption at sub-national level.",
                          "toc_mapping": [
                            {
                              "science_program_id": "SP07",
                              "aow_compose_code": "SP07-AOW01",
                              "result_title": "Sub-national dataset",
                              "result_indicator_description": "Datasets published",
                              "result_indicator_type_name": "# Of Knowledge Products"
                            }
                          ],
                          "geo_focus": {
                            "scope_code": 5,
                            "scope_label": "Sub-national",
                            "countries": [
                              {
                                "id": 404,
                                "name": "Kenya",
                                "iso_alpha_3": "KEN",
                                "iso_alpha_2": "KE"
                              }
                            ],
                            "subnational_areas": [
                              { "id": 1, "name": "Nairobi County" }
                            ]
                          },
                          "contributing_center": [
                            { "institution_id": 115, "acronym": "CIFOR" }
                          ],
                          "contributing_partners": [
                            { "institution_id": 501, "acronym": "NEMA" }
                          ],
                          "evidence": [
                            {
                              "link": "https://example.org/dataset",
                              "description": "Open dataset landing page"
                            }
                          ],
                          "contributing_bilateral_projects": [
                            { "grant_title": "County Seed Data" }
                          ],
                          "knowledge_product": {
                            "handle": "hdl:20.500.12345/kedata-2025",
                            "knowledge_product_type": "Dataset",
                            "metadataCG": {
                              "source": "CGSpace",
                              "accessibility": true,
                              "doi": "10.1000/ds.2025.09",
                              "is_isi": false,
                              "is_peer_reviewed": false,
                              "issue_year": 2025
                            },
                            "licence": "CC-BY 4.0",
                            "agrovoc_keywords": ["Datasets", "Adoption"]
                          }
                        }
                      }
                    ]
                  }
                },
                "kpGlobal": {
                  "summary": "Knowledge Product — Global (scope_code=1, should NOT send regions/countries/subnational_areas)",
                  "value": {
                    "tenant": "prms.result-management.api",
                    "results": [
                      {
                        "type": "knowledge_product",
                        "data": {
                          "created_date": "2025-10-01T10:15:00Z",
                          "created_by": {
                            "email": "global.research@cgiar.org",
                            "name": "Global Research Coordinator"
                          },
                          "submitted_by": {
                            "email": "g.khan@cgiar.org",
                            "name": "Gul Khan",
                            "submitted_date": "2025-10-10T14:20:00Z"
                          },
                          "lead_center": "Alliance",
                          "title": "Global meta-analysis on seed adoption",
                          "description": "A meta-analysis summarizing seed adoption globally.",
                          "toc_mapping": [
                            {
                              "science_program_id": "SP01",
                              "aow_compose_code": "SP01-AOW01",
                              "result_title": "Global meta-analysis",
                              "result_indicator_description": "Meta-analyses completed",
                              "result_indicator_type_name": "# Of Knowledge Products"
                            }
                          ],
                          "geo_focus": {
                            "scope_code": 1,
                            "scope_label": "Global"
                          },
                          "contributing_center": [
                            { "institution_id": 1279, "acronym": "ICARDA" }
                          ],
                          "contributing_partners": [
                            { "institution_id": 10, "acronym": "FAO" }
                          ],
                          "evidence": [
                            {
                              "link": "https://example.org/global-meta",
                              "description": "Global meta study"
                            }
                          ],
                          "contributing_bilateral_projects": [
                            { "grant_title": "Global Evidence 2025" }
                          ],
                          "knowledge_product": {
                            "handle": "hdl:20.500.12345/global-2025",
                            "knowledge_product_type": "Journal Article",
                            "metadataCG": {
                              "source": "CGSpace",
                              "accessibility": true,
                              "doi": "10.1000/j.jas.2025.77",
                              "is_isi": true,
                              "is_peer_reviewed": true,
                              "issue_year": 2025
                            },
                            "licence": "CC-BY 4.0",
                            "agrovoc_keywords": ["Global", "Seeds"]
                          }
                        }
                      }
                    ]
                  }
                },
                "kpMinimal": {
                  "summary": "Minimal valid example (required fields only)",
                  "value": {
                    "tenant": "prms.result-management.api",
                    "results": [
                      {
                        "type": "knowledge_product",
                        "data": {
                          "created_date": "2025-10-10T08:45:00Z",
                          "created_by": {
                            "email": "test.creator@alliance.org",
                            "name": "Test Creator"
                          },
                          "submitted_by": {
                            "email": "min.user@alliance.org",
                            "name": "Min User",
                            "submitted_date": "2025-10-10T09:00:00Z"
                          },
                          "lead_center": "CIAT",
                          "title": "Minimal KP",
                          "description": "Short description.",
                          "toc_mapping": [
                            {
                              "science_program_id": "SP02",
                              "aow_compose_code": "SP02-AOW01",
                              "result_title": "Minimal",
                              "result_indicator_description": "n/a",
                              "result_indicator_type_name": "# Of Knowledge Products"
                            }
                          ],
                          "geo_focus": {
                            "scope_code": 1,
                            "scope_label": "Global"
                          },
                          "contributing_center": [
                            { "institution_id": 115, "acronym": "CIFOR" }
                          ],
                          "contributing_partners": [
                            { "institution_id": 2, "acronym": "CGIAR" }
                          ],
                          "evidence": [
                            {
                              "link": "https://example.org/min",
                              "description": "ref"
                            }
                          ],
                          "contributing_bilateral_projects": [
                            { "grant_title": "MIN-001" }
                          ],
                          "knowledge_product": {
                            "handle": "hdl:20.500.12345/min",
                            "knowledge_product_type": "Other",
                            "metadataCG": {
                              "source": "CGSpace",
                              "accessibility": true,
                              "doi": "10.1000/min.1",
                              "is_isi": false,
                              "is_peer_reviewed": false,
                              "issue_year": 2025
                            },
                            "licence": "CC-BY 4.0",
                            "agrovoc_keywords": ["Test"]
                          }
                        }
                      }
                    ]
                  }
                },
                "kpBatchTwo": {
                  "summary": "Batch with 2 results",
                  "value": {
                    "tenant": "prms.result-management.api",
                    "op": "dataset.ingest.requested",
                    "results": [
                      {
                        "$ref": "#/paths/~1ingest/post/requestBody/content/application~1json/examples/kpRegional/value/results/0"
                      },
                      {
                        "$ref": "#/paths/~1ingest/post/requestBody/content/application~1json/examples/kpNational/value/results/0"
                      }
                    ]
                  }
                },
                "invalidExample": {
                  "summary": "Invalid example (validation fails)",
                  "value": {
                    "tenant": "prms.result-management.api",
                    "results": [
                      {
                        "type": "knowledge_product",
                        "data": {
                          "created_date": "2025-10-10T16:30:00Z",
                          "created_by": {
                            "email": "invalid.creator@alliance.org",
                            "name": "Invalid Creator"
                          },
                          "submitted_by": {
                            "email": "bad@alliance.org",
                            "name": "Bad User",
                            "submitted_date": "2025-10-10T16:45:00Z"
                          },
                          "lead_center": "CIAT",
                          "title": "Invalid KP",
                          "description": "Missing geo_focus and evidence, will fail.",
                          "toc_mapping": [
                            {
                              "science_program_id": "SP99",
                              "aow_compose_code": "SP99-AOW01",
                              "result_title": "Invalid",
                              "result_indicator_description": "n/a",
                              "result_indicator_type_name": "# Of Knowledge Products"
                            }
                          ],
                          "knowledge_product": {
                            "handle": "hdl:20.500.12345/invalid",
                            "knowledge_product_type": "Other",
                            "metadataCG": {
                              "source": "CGSpace",
                              "accessibility": true,
                              "doi": "10.1000/invalid.1",
                              "is_isi": false,
                              "is_peer_reviewed": false,
                              "issue_year": 2025
                            },
                            "licence": "CC-BY 4.0"
                          }
                        }
                      }
                    ]
                  }
                }
              }
            }
          }
        },
        "responses": {
          "202": { "description": "Accepted and published to EventBridge" },
          "400": { "description": "Bad Request (missing wrapper fields)" },
          "422": { "description": "Validation failed for all items" },
          "500": { "description": "Internal error (EventBridge/S3)" }
        }
      }
    },
    "/health": {
      "get": {
        "summary": "Healthcheck",
        "responses": {
          "200": { "description": "Service OK" }
        }
      }
    }
  },
  "components": {
    "schemas": {
      "IngestRequest": {
        "type": "object",
        "required": ["results"],
        "properties": {
          "tenant": {
            "type": "string",
            "example": "prms.result-management.api"
          },
          "op": {
            "type": "string",
            "enum": ["dataset.ingest.requested", "update", "delete"],
            "default": "dataset.ingest.requested"
          },
          "results": {
            "type": "array",
            "items": {
              "type": "object",
              "required": ["type", "data"],
              "properties": {
                "type": { "type": "string", "example": "knowledge_product" },
                "op": {
                  "type": "string",
                  "enum": ["create", "update", "delete"]
                },
                "data": { "type": "object" }
              }
            }
          }
        }
      }
    }
  }
}
